<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Room2Music</title>
  <style>
    :root { --bg:#f8fafc; --fg:#0f172a; --muted:#475569; --card:#fff; --border:#e2e8f0; --accent:#0f172a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Noto Sans,"Helvetica Neue",Arial;color:var(--fg);background:linear-gradient(#fff,var(--bg))}
    .container{max-width:1040px;margin:0 auto;padding:24px}
    .hero{display:grid;grid-template-columns:1fr;gap:24px;padding:32px 0}
    @media(min-width:900px){.hero{grid-template-columns:1fr 1fr;align-items:center}}
    h1{font-size:clamp(28px,4vw,48px);margin:0 0 12px;font-weight:900}
    p.lead{font-size:18px;color:var(--muted);line-height:1.7}
    .btn{display:inline-flex;align-items:center;gap:8px;border-radius:16px;padding:12px 18px;text-decoration:none;font-weight:600;border:1px solid var(--border)}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn:hover{filter:brightness(.96)}
    .btn[disabled]{opacity:.5;pointer-events:none}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .card.pad{padding:24px}
    .imgbox{aspect-ratio:16/9;width:100%;overflow:hidden;border-radius:16px;border:1px solid var(--border)}
    .imgbox img{width:100%;height:100%;object-fit:cover;display:block}
    .pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;color:#334155;background:#f8fafc}

    .progress{width:100%;height:8px;border-radius:999px;background:#e2e8f0;overflow:hidden}
    .progress>div{height:100%;background:var(--accent);width:0%;transition:width .25s ease}

    .options{display:grid;gap:12px}
    .option{ text-align:left;border:1px solid var(--border);border-radius:16px;padding:14px;background:#fff;cursor:pointer;display:flex;gap:12px;align-items:flex-start;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .option:hover{border-color:#cbd5e1}
    .option.selected{background:#0f172a;color:#fff;border-color:#0f172a}
    .option .num{width:24px;height:24px;border-radius:50%;border:1px solid #cbd5e1;display:inline-flex;align-items:center;justify-content:center;font-size:12px;background:#f1f5f9;color:#334155;margin-top:2px}
    .option.selected .num{background:#fff;color:#0f172a;border-color:transparent}

    .quiz-nav{display:flex;justify-content:space-between;align-items:center;margin-top:16px;gap:12px}

    .result-grid{display:grid;gap:24px;grid-template-columns:1fr}
    @media(min-width:900px){.result-grid{grid-template-columns:1fr 1fr}}
    .teacher-photo{width:100%;height:260px;object-fit:cover;border-bottom:1px solid var(--border);display:block}
    .runner{display:flex;gap:12px;align-items:center}
    .runner img{width:56px;height:56px;border-radius:12px;border:1px solid var(--border);object-fit:cover}
    .muted{color:var(--muted)}
    .fade-enter{opacity:0;transform:translateX(24px)}
    .fade-enter.active{opacity:1;transform:translateX(0);transition:all .2s ease}
    .fade-exit{opacity:1;transform:translateX(0)}
    .fade-exit.active{opacity:0;transform:translateX(-24px);transition:all .2s ease}
  </style>
</head>
<body>
  <div class="container">
    <!-- Hero -->
    <section class="hero">
      <div>
        <h1>Room2Music</h1>
        <h2>貳館音樂</h2>
        <p class="lead">我們相信「好老師，會讓你更想練」。填寫 60 秒問卷，立刻為你精準配對最合拍的老師與課程方向。</p>
        <div style="display:flex;gap:12px;margin-top:16px">
          <a href="#quiz" class="btn primary" id="startQuiz">開始 60 秒配對</a>
          <a href="#contact" class="btn">聯絡我們</a>
        </div>
      </div>
      <div>
        <div class="imgbox">
          <img src="https://placehold.co/960x540?text=Music+School+Hero" alt="Music classroom">
        </div>
        <div class="pills">
          <span class="pill">電/木吉他</span><span class="pill">流行/爵士</span><span class="pill">檢定/比賽</span><span class="pill">兒童友善</span>
        </div>
      </div>
    </section>

    <!-- Quiz -->
    <section id="quizSection" class="card pad" style="display:none">
      <div style="margin-bottom:16px">
        <div style="display:flex;justify-content:space-between;font-size:14px;color:var(--muted);margin-bottom:8px">
          <span>進度</span><span id="progressText">1 / 9（0%）</span>
        </div>
        <div class="progress"><div id="progressBar"></div></div>
      </div>
      <div id="questionWrap"></div>
      <div class="quiz-nav">
        <button class="btn" id="prevBtn">上一題</button>
        <button class="btn primary" id="nextBtn">下一題</button>
      </div>
    </section>

    <!-- Result -->
    <section id="resultSection" style="display:none">
      <div class="result-grid">
        <div class="card">
          <img id="topPhoto" class="teacher-photo" src="" alt="最佳老師">
          <div class="pad">
            <h3 style="margin:0 0 6px;font-size:22px;font-weight:700">最適合你的老師</h3>
            <p id="topName" style="margin:0 0 10px;font-size:18px;font-weight:800"></p>
            <div id="topTags" class="pills" style="margin-bottom:10px"></div>
            <p id="topBio" class="muted" style="line-height:1.7"></p>
            <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
              <a href="#contact" class="btn primary">立刻聯絡/預約體驗課</a>
              <button class="btn" id="retryBtn">重新測一次</button>
            </div>
          </div>
        </div>
        <div class="card pad">
          <h4 style="margin:0 0 10px;font-size:18px;font-weight:700">次佳人選</h4>
          <div id="runnerList" style="display:grid;gap:12px"></div>
          <p class="muted" style="font-size:12px;margin-top:12px">* 若最適合的時段滿班，以上老師也非常契合你的學習偏好。</p>
        </div>
      </div>
    </section>

    <!-- Contact（鏡像 Google 表單） -->
    <form id="gform"
          class="card pad"
          style="margin:28px 0 10px"
          action="#"
          method="POST">

      <h3 style="margin:0 0 10px;font-size:22px;font-weight:800">聯絡我們</h3>
      <p class="muted" style="margin-top:0">地址：桃園市XX區XX路100號｜電話：(03) 123-4567｜LINE：@musicschool</p>

      <div style="display:grid;gap:16px;grid-template-columns:1fr">
        <div>
          <label class="muted" style="font-size:14px">你的姓名</label>
          <!-- 姓名：entry.465133692 -->
          <input id="nameInput"
                name="entry.465133692"
                placeholder="王小明" required
                style="margin-top:6px;width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border)">
        </div>

        <div>
          <label class="muted" style="font-size:14px">聯絡方式（Email / 手機）</label>
          <!-- 聯絡方式：entry.331042393 -->
          <input id="contactInput"
                name="entry.331042393"
                placeholder="example@gmail.com" required
                style="margin-top:6px;width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border)">
        </div>

        <div>
          <label class="muted" style="font-size:14px">想學的內容/備註</label>
          <!-- 備註：entry.90522651 -->
          <textarea id="noteInput"
                    name="entry.90522651"
                    placeholder="例如：想學流行鋼琴、上課時間偏好週末..."
                    style="margin-top:6px;width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);height:120px"></textarea>
        </div>
        <div>
          <button type="submit" class="btn primary" style="width:100%;justify-content:center">送出留言</button>
          <p class="muted" style="font-size:12px;margin-top:8px">
            本頁面為純前端，資料透過 Google Apps Script 安全寫入你的 Google 試算表。
          </p>
          <div id="contactStatus" class="muted" style="margin-top:6px"></div>
        </div>
      </div>

      <div style="text-align:center;color:#6b7280;font-size:13px;margin-top:20px">
        © <span id="year"></span> room2Music — 讓學音樂變得更輕鬆。
      </div>
    </form>


  </div>

  <!-- 外部資料檔 -->
  <script src="assets/data/quiz_data.js"></script>

  <!-- 主程式 -->
  <script>
    const { questions, teachers } = window.quizData;

    // ========= 狀態 =========
    const $ = (s) => document.querySelector(s);
    const quizSection = $('#quizSection');
    const resultSection = $('#resultSection');
    const startQuizBtn = $('#startQuiz');
    const prevBtn = $('#prevBtn');
    const nextBtn = $('#nextBtn');
    const progressBar = $('#progressBar');
    const progressText = $('#progressText');
    const questionWrap = $('#questionWrap');

    const total = questions.length;
    let step = 0;       // 0=hero, 1=quiz, 2=result
    let current = 0;    // 目前題號 index
    // 答案陣列：單選存數字 index；複選存陣列 [index, index]
    let answers = questions.map(q => q.multiple ? [] : null);
    // 🎯 樂器分流權重（可自行微調）
    const INSTRUMENT_WEIGHT_EXACT = 3;   // 同型（例：選電吉他 + 電吉他老師）
    const INSTRUMENT_WEIGHT_CROSS = 1;   // 跨型（例：選電吉他 + 木吉他老師）
    const INSTRUMENT_PREF_BONUS   = 2;   // 老師在 preferences[1] 偏好你的樂器，再加成
    const GUITAR_SET = new Set(["電吉他", "木吉他"]);
    

    // ========= UI =========
    function showSection(which){
      quizSection.style.display = which === 1 ? 'block' : 'none';
      resultSection.style.display = which === 2 ? 'block' : 'none';
      step = which;
    }

    function updateProgress(){
      const percent = Math.round(((current + 1) / total) * 100);
      progressBar.style.width = percent + '%';
      progressText.textContent = `${current + 1} / ${total}（${percent}%）`;
    }

    function renderQuestion(){
      updateProgress();
      const q = questions[current];
      const old = questionWrap.firstElementChild;
      if (old){
        old.className = 'fade-exit';
        requestAnimationFrame(()=>{ old.className = 'fade-exit active';
          setTimeout(()=>{ questionWrap.removeChild(old); pushNew(); }, 180);
        });
      } else { pushNew(); }
      function setNavState(q){
        prevBtn.disabled = current === 0;
        nextBtn.textContent = (current < total - 1) ? '下一題' : '看結果';
        nextBtn.disabled = q.multiple
            ? !(answers[current] && answers[current].length > 0)
            : (answers[current] == null);
        }
      function pushNew(){
        const wrap = document.createElement('div');
        wrap.className = 'fade-enter';
        wrap.innerHTML = `
            <h2 style="margin:0 0 12px;font-size:24px;font-weight:800;">${q.title}</h2>
            <div class="options">
            ${q.options.map((label, i) => {
                const selected = q.multiple
                ? (answers[current] || []).includes(i)
                : answers[current] === i;
                return `
                <button class="option ${selected ? 'selected' : ''}"
                        data-index="${i}" aria-pressed="${selected}">
                    <span class="num">${i+1}</span>
                    <span>${label}</span>
                </button>`;
            }).join('')}
            </div>
        `;
        questionWrap.appendChild(wrap);
        requestAnimationFrame(()=>{ wrap.className = 'fade-enter active'; });

        // ✅ 只更新樣式與答案，不呼叫 renderQuestion()，避免動畫觸發
        const optionButtons = wrap.querySelectorAll('.option');
        optionButtons.forEach(btn => {
            btn.addEventListener('click', () => {
            const i = Number(btn.getAttribute('data-index'));

            if (q.multiple) {
                // 複選：切換該按鈕選取狀態
                const arr = Array.isArray(answers[current]) ? [...answers[current]] : [];
                const pos = arr.indexOf(i);
                const willSelect = pos === -1;
                if (willSelect) arr.push(i); else arr.splice(pos, 1);
                answers[current] = arr.sort((a,b)=>a-b);

                // 更新該按鈕樣式與 aria
                btn.classList.toggle('selected', willSelect);
                btn.setAttribute('aria-pressed', String(willSelect));
            } else {
                // 單選：清掉其他的 selected，僅標記當前
                answers[current] = i;
                optionButtons.forEach(b => {
                const idx = Number(b.getAttribute('data-index'));
                const on = idx === i;
                b.classList.toggle('selected', on);
                b.setAttribute('aria-pressed', String(on));
                });
            }

            // 依目前答案狀態更新「下一題」按鈕是否啟用
            setNavState(q);
            });
        });

        // 初次渲染時設定按鈕狀態
        setNavState(q);
        }
    }
    

    // ========= 配對演算法 =========
    // 規則：每一題，只要「學員答案」包含在老師該題的可接受清單，就加 1 分。
    // 複選題：每個符合的選項各加 1 分（多選多得）。
   function computeScores(){
      // 第 1 題（樂器）作為分流前提
      const ansInstrumentIdx = answers[0]; // q1 一定是第一題
      const instrumentLabel = ansInstrumentIdx != null ? questions[0].options[ansInstrumentIdx] : null;

      // 先依樂器挑出候選老師
      const candidates = teachers.filter(t => {
        if (!instrumentLabel) return true; // 理論上不會發生（下一題前會鎖定）
        if (GUITAR_SET.has(instrumentLabel)) {
          // 吉他組：兩邊老師都可教
          return GUITAR_SET.has(t.instrument);
        } else {
          // 其他樂器：老師必須能教該樂器才納入
          const canTeach = Array.isArray(t.canTeach)
            ? t.canTeach.includes(instrumentLabel)
            : (t.instrument === instrumentLabel);
          return canTeach;
        }
      });

      // 對候選老師計分
      const scoreList = candidates.map(t => {
        let score = 0;

        // 1) 樂器加權（只在有選第 1 題時）
        if (instrumentLabel) {
          // 同/跨型加權
          if (GUITAR_SET.has(instrumentLabel)) {
            score += (t.instrument === instrumentLabel)
              ? INSTRUMENT_WEIGHT_EXACT
              : INSTRUMENT_WEIGHT_CROSS;
          } else {
            // 非吉他：候選都已能教 -> 給同型高分
            score += (t.instrument === instrumentLabel)
              ? INSTRUMENT_WEIGHT_EXACT
              : INSTRUMENT_WEIGHT_CROSS; // 你也可設為 0
          }
          // 偏好加成：老師在第 1 題 preferences 內包含此樂器選項（1-based）
          const pref1 = t.preferences?.[1];
          if (pref1 && pref1.includes(ansInstrumentIdx + 1)) {
            score += INSTRUMENT_PREF_BONUS;
          }
        }

        // 2) 其他題（2～9）照舊加分；第 1 題不再當一般題目計分
        questions.forEach((q, qi) => {
          if (q.id === 1) return; // 跳過樂器題
          const accept = t.preferences[q.id];
          if (!accept) return;
          const ans = answers[qi];
          if (q.multiple) {
            (ans || []).forEach(idx => {
              if (accept.includes(idx + 1)) score += 1;
            });
          } else {
            if (ans != null && accept.includes(ans + 1)) score += 1;
          }
        });

        return { id: t.id, score };
      });

      // 依分數排序（若完全沒有候選，回傳空陣列）
      scoreList.sort((a,b) => b.score - a.score);
      return scoreList;
    }


    function renderResult(){
      const ranking = computeScores();
      const top = teachers.find(t => t.id === ranking[0]?.id);
      const ansInstrumentIdx = answers[0];
      const instrumentLabel = ansInstrumentIdx != null ? questions[0].options[ansInstrumentIdx] : null;

      // 若沒找到老師，給出針對性說明
      if (!top) {
        const topName = document.getElementById('topName');
        const topBio  = document.getElementById('topBio');
        if (topName) topName.textContent = '暫無對應老師';
        if (topBio)  topBio.textContent  = instrumentLabel
          ? `目前尚無「${instrumentLabel}」對應的老師，歡迎先留言，我們會協助安排或推薦。`
          : '目前暫無推薦，請調整作答條件再試一次。';
      }
      const runners = ranking.slice(1,3).map(r => teachers.find(t => t.id === r.id));

      // Top
      const topPhoto = $('#topPhoto');
      const topName = $('#topName');
      const topBio  = $('#topBio');
      const topTags = $('#topTags');

      topPhoto.src = top?.photo || 'https://placehold.co/600x400?text=Teacher';
      topPhoto.alt = top?.name || '最佳老師';
      topName.textContent = top?.name || '暫無推薦';
      topBio.textContent  = top
        ? `授課樂器：${top.instrument}｜（可聯絡我們安排體驗課）`
        : '請調整你的作答條件再試一次。';
      topTags.innerHTML = '';
      // 這裡可自由放標籤（示意：老師樂器與性別）
      if (top){
        ["#"+top.instrument, top.gender ? "性別："+top.gender : null]
          .filter(Boolean)
          .forEach(tag=>{
            const el = document.createElement('span');
            el.className = 'pill';
            el.textContent = tag;
            topTags.appendChild(el);
          });
      }

      // Runners
      const runnerList = $('#runnerList');
      runnerList.innerHTML = '';
      runners.forEach(r => {
        if (!r) return;
        const row = document.createElement('div');
        row.className = 'runner';
        row.innerHTML = `
          <img src="${r.photo || 'https://placehold.co/96x96?text=T'}" alt="${r.name}">
          <div>
            <div style="font-weight:600">${r.name}</div>
            <div class="muted" style="font-size:13px">授課樂器：${r.instrument}</div>
          </div>`;
        runnerList.appendChild(row);
      });
    }

    // ========= 導航 =========
    function next(){
      if (current < total - 1){
        current++;
        renderQuestion();
      } else {
        renderResult();
        showSection(2);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }
    function prev(){ if (current > 0){ current--; renderQuestion(); } }
    function resetAll(){
      current = 0;
      answers = questions.map(q => q.multiple ? [] : null);
      showSection(1);
      renderQuestion();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ========= 綁定 =========
    startQuizBtn.addEventListener('click', e => { e.preventDefault(); showSection(1); renderQuestion(); });
    nextBtn.addEventListener('click', next);
    prevBtn.addEventListener('click', prev);
    document.addEventListener('keydown', e => { if (step===1){ if (e.key==='ArrowRight') next(); if (e.key==='ArrowLeft') prev(); }});
    
    $('#year').textContent = new Date().getFullYear();
    // 結果頁「重新測一次」
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.id === 'retryBtn') resetAll();
    });
    const GS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyo4x1NhH7JkC6QVzXFt5Rh-TSxqHX4L2vH2FRjowmy8d59k7GdZyOTIiyQyqk-Q9Lx1w/exec';

  // 取得單題答案：複選回傳陣列，單選回傳文字
  function getAnswer(q, qi) {
    if (q.multiple) return (answers[qi] || []).map(i => q.options[i]);
    const i = answers[qi];
    return (i != null ? q.options[i] : '');
  }

  // 組成要送到 Apps Script 的 payload
  function buildPayload() {
      const ranking = computeScores();
      const top = teachers.find(t => t.id === ranking[0]?.id);
      const topText = top ? `${top.name}（${top.instrument}）` : '無';
      const top3 = (ranking || []).slice(0,3)
        .map((r,i)=>`${i+1}.${teachers.find(t=>t.id===r.id)?.name || r.id}(${r.score})`)
        .join(' / ');
      const match = `${topText}｜Top3：${top3}`;

      return {
        name: document.getElementById('nameInput').value.trim(),
        contact: document.getElementById('contactInput').value.trim(),
        note: document.getElementById('noteInput').value.trim(),
        match,
        q1:getAnswer(questions[0],0), q2:getAnswer(questions[1],1), q3:getAnswer(questions[2],2),
        q4:getAnswer(questions[3],3), q5:getAnswer(questions[4],4), q6:getAnswer(questions[5],5),
        q7:getAnswer(questions[6],6), q8:getAnswer(questions[7],7), q9:getAnswer(questions[8],8)
      };
    }

      // 送出到 Apps Script（JSON；用 text/plain 避開預檢）
      (() => {
        const form = document.getElementById('gform');
        if (!form) return;
        const statusBox = document.getElementById('contactStatus');
        const submitBtn = form.querySelector('button[type="submit"]');
        let submitting = false;

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (submitting) return;
          submitting = true;

          try {
            if (submitBtn) submitBtn.disabled = true;
            if (statusBox) statusBox.textContent = '傳送中…';

            const payload = buildPayload();
            console.log('payload =', payload); // ← 開發時看看是否都有值

            const res = await fetch(GS_ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // 關鍵：簡易請求
              body: JSON.stringify(payload)
            });

            const json = await res.json();   // 你的 doPost 會回傳 { ok:true, data:{...} }
            console.log('server says:', json);
            if (!json.ok) throw new Error(json.error || 'server error');

            if (statusBox) statusBox.textContent = '已送出，我們會盡快與你聯絡！';
            form.reset();

          } catch (err) {
            console.error(err);
            if (statusBox) statusBox.textContent = '送出失敗，請稍後再試或改用 LINE 聯絡我們。';
          } finally {
            if (submitBtn) submitBtn.disabled = false;
            submitting = false;
          }
        });
      })();


  </script>
</body>
</html>
