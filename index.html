<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Room2Music</title>
  <style>
    :root { --bg:#f8fafc; --fg:#0f172a; --muted:#475569; --card:#fff; --border:#e2e8f0; --accent:#0f172a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Noto Sans,"Helvetica Neue",Arial;color:var(--fg);background:linear-gradient(#fff,var(--bg))}
    .container{max-width:1040px;margin:0 auto;padding:24px}
    .hero{display:grid;grid-template-columns:1fr;gap:24px;padding:32px 0}
    @media(min-width:900px){.hero{grid-template-columns:1fr 1fr;align-items:center}}
    h1{font-size:clamp(28px,4vw,48px);margin:0 0 12px;font-weight:900}
    p.lead{font-size:18px;color:var(--muted);line-height:1.7}
    .btn{display:inline-flex;align-items:center;gap:8px;border-radius:16px;padding:12px 18px;text-align: center;text-decoration:none;font-weight:600;border:1px solid var(--border)}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn:hover{filter:brightness(.96)}
    .btn[disabled]{opacity:.5;pointer-events:none}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .card.pad{padding:24px}
    .imgbox{aspect-ratio:16/9;width:100%;overflow:hidden;border-radius:0;border:none}
    .imgbox img{width:100%;height:100%;object-fit:cover;display:block}
    .pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;color:#334155;background:#f8fafc}

    .progress{width:100%;height:8px;border-radius:999px;background:#e2e8f0;overflow:hidden}
    .progress>div{height:100%;background:var(--accent);width:0%;transition:width .25s ease}

    .options{display:grid;gap:12px}
    .option{ text-align:left;border:1px solid var(--border);border-radius:16px;padding:14px;background:#fff;cursor:pointer;display:flex;gap:12px;align-items:flex-start;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .option:hover{border-color:#cbd5e1}
    .option.selected{background:#0f172a;color:#fff;border-color:#0f172a}
    .option .num{width:24px;height:24px;border-radius:50%;border:1px solid #cbd5e1;display:inline-flex;align-items:center;justify-content:center;font-size:12px;background:#f1f5f9;color:#334155;margin-top:2px}
    .option.selected .num{background:#fff;color:#0f172a;border-color:transparent}

    .quiz-nav{display:flex;justify-content:space-between;align-items:center;margin-top:16px;gap:12px}

    .result-grid{display:grid;gap:24px;grid-template-columns:1fr}
    @media(min-width:900px){.result-grid{grid-template-columns:1fr 1fr}}
    .teacher-photo{width:100%;height:260px;object-fit:cover;border-bottom:1px solid var(--border);display:block}
    
    /* 讓每個 runner 項目內部更平衡 */
    .runner {
      display:flex;
      flex-direction: column; /* 讓圖片和文字上下排列 */
      align-items: center; /* 水平居中 */
      text-align: center; /* 文字也居中 */
      gap: 8px; /* 圖片和文字之間的間距 */
    }

    /* 調整圖片尺寸 */
    .runner img {
      width: 90px;
      height: 90px;
      border-radius: 12px; /* 改成圓形圖片，更具設計感 */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* 輕微陰影，增加立體感 */
    }

    /* 調整文字樣式 */
    .runner .name {
      font-size: 18px; /* 讓名字更突出 */
      font-weight: 600;
    }
    .runner .muted {
      font-size: 14px; /* 樂器名稱維持小一點 */
    }

    .muted{color:var(--muted)}
    .fade-enter{opacity:0;transform:translateX(24px)}
    .fade-enter.active{opacity:1;transform:translateX(0);transition:all .2s ease}
    .fade-exit{opacity:1;transform:translateX(0)}
    .fade-exit.active{opacity:0;transform:translateX(-24px);transition:all .2s ease}


    /* === 背景 === */
    body {
      background: radial-gradient(circle at top, #1a1a2e, #0a0a0a 70%);
      color: #fff;
      font-family: "Noto Sans TC", sans-serif;
    }

    /* 浮動音符 + 貓咪 */
    .floating-icons {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    .floating-icons span {
      position: absolute;
      font-size: 24px;
      color: rgba(233,30,99,0.5); /* 粉紅亮色 */
      animation: floatAnim 12s linear infinite;
    }
    @keyframes floatAnim {
      0%   { transform: translateY(100vh) scale(0.8); opacity: 0; }
      20%  { opacity: 1; }
      100% { transform: translateY(-20vh) scale(1.2); opacity: 0; }
    }

    /* 調整文字顏色 */
    p, label, input, textarea {
      color: #f5f5f5;
    }
    .muted {
      color: #ccc !important;
    }

    /* 卡片 */
    .card {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      color: #fff;
    }

    /* 按鈕 */
    .btn.primary {
      background: linear-gradient(90deg, #e91e63, #8e24aa);
      color: #fff;
      border: none;
      box-shadow: 0 0 10px rgba(233,30,99,0.6);
    }
    .btn.primary:hover {
      box-shadow: 0 0 16px rgba(233,30,99,0.9);
      transform: scale(1.05);
    }

    .btn.second {
      background: linear-gradient(45deg, #917884, #b4a5a0);
      color: #fff;
      border: none;
      box-shadow: 0 0 10px rgba(255, 105, 180, 0.4);
    }
    .btn.second:hover {
      box-shadow: 0 0 16px rgba(255, 105, 180, 0.6);
      transform: translateY(-2px); /* 向上輕微移動，提供「抬起」的動態感 */
    }
    #retryBtn:hover {
      box-shadow: 0 0 16px rgba(120, 120, 120, 0.6); /* 調整為灰色調的陰影 */
      transform: translateY(-2px);
    }

    /* 選項 */
    .option {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
    }
    .option:hover {
      background: rgba(233,30,99,0.2);
    }
    .option.selected {
      background: linear-gradient(90deg, #ff9a9e, #e91e63);
      color: #fff;
      font-weight: bold;
    }

    input, textarea {
      color: #333; /* 這會讓使用者輸入的文字變成深灰色 */
    }

    .action-buttons {
      display: flex;
      justify-content: center; /* 置中 */
      gap: 16px; /* 按鈕間距 */
      margin-top: 24px;
      width: calc(100% - 40px); /* 左右各留 20px 間距 */
      margin-left: auto;
      margin-right: auto;
    }
    /* 讓按鈕們平分空間 */
    .action-buttons .btn {
      flex: 1;
      /* 您可以移除原有的 padding，若想統一大小，統一設定 width 也可以 */
      /* padding: 12px 18px; */
      /* min-width: 0;  如果按鈕內容過長，需要這行來確保 flex: 1 能生效 */
    }
    @media (max-width: 768px) { /* 根據您的設計斷點調整 */
      .action-buttons {
        flex-direction: column;
        width: calc(100% - 40px); /* 保持寬度 */
        margin-left: 20px;
        margin-right: 20px;
      }
      .action-buttons .btn {
        flex: none; /* 移除 flex: 1 */
        width: 100%; /* 佔滿寬度 */
        margin: 8px 0; /* 在堆疊時增加垂直間距 */
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Hero -->
    <section class="hero">
      <div>
      <!--  <h1>Room2Music</h1>-->
        <h1>貳館音樂</h1>
          <p style="color: white;">找到你的樂器，遇見適合你的老師，讓音樂融入生活！<br>不論你的目標是什麼，我們都能為你精準配對最適合的老師與課程。</p>        <div style="display:flex;gap:12px;margin-top:16px">
          <a href="#quiz" class="btn primary" id="startQuiz">開始 60 秒配對</a>
          <a href="#contact" class="btn second">聯絡我們</a>
        </div>
      </div>
      <div>
        <div class="imgbox">
          <img src="photo/room2logo.png" alt="Music classroom">
        </div>
        <div class="pills">
          <span class="pill">電/木吉他</span><span class="pill">Bass</span><span class="pill">爵士鼓</span><span class="pill">兒童友善</span><span class="pill">檢定/比賽</span>
        </div>
      </div>
    </section>

    <!-- About -->
    <section id="about" class="card pad" style="margin:28px 0">
      <h3 style="margin:0 0 10px;font-size:22px;font-weight:800">關於 Room2Music</h3>
      <div style="line-height:1.7; color:#f5f5f5;">
        <p style="font-weight:bold; font-size:18px;">
          🎵🎶貳館音樂：實現你的音樂夢想🎶🎵
        </p>
        <p>
          Room2Music致力於點燃每一位學員對音樂的熱情，猶如心臟般強而有力地鼓動著。
        </p>
        <p>
          這裡提供多元化的音樂教學，從樂器入門到進階演奏，都能讓你找到屬於自己的節奏。不論你是想學習吉他、貝斯、爵士鼓，或是挑戰其他樂器，貳館音樂都將陪伴你探索音樂的無限可能。
        </p>
        <p style="font-weight:bold; margin-top:20px;">
          📍我們的教學據點：
        </p>
        <ul style="list-style-type:none; padding:0; margin:0;">
          <li>嘉義市東區學府路</li>
          <li>台南市東寧路西段22號B1</li>
          <li>高雄市新興區中正三路127號</li>
        </ul>
        <p style="margin-top:20px;">
          方便你隨時加入我們的音樂大家庭。
        </p>
        <p style="font-weight:bold; margin-top:20px;">
          ✨ 更多詳細內容，追蹤我們下列聯絡方式！隨時掌握最新課程資訊與活動動態！
        </p>
      </div>
    </section>

    <!-- Quiz -->
    <section id="quizSection" class="card pad" style="display:none">
      <div style="margin-bottom:16px">
        <div style="display:flex;justify-content:space-between;font-size:14px;color:var(--muted);margin-bottom:8px">
          <span style="color: rgb(182, 181, 181);">進度</span><span style="color: rgb(182, 181, 181)" id="progressText" >1 / 11（0%）</span>
        </div>
      <div class="progress" style="background-color: #e0e0e0;">
        <div id="progressBar" style="background-color: #a04857; width: 50%;"></div>
      </div>
      </div>
      <div id="questionWrap"></div>
      <div class="quiz-nav">
        <button class="btn" id="prevBtn">上一題</button>
        <button class="btn primary" id="nextBtn">下一題</button>
      </div>
    </section>

    <!-- Result -->
    <section id="resultSection" style="display:none; padding: 20px;">
      <div style="max-width: 900px; margin: 0 auto; display:grid; gap:24px; grid-template-columns:1fr;">
        <div class="card pad" style="text-align:center;">
          <h3 style="margin:0 0 10px;font-size:24px;font-weight:700">最適合你的老師</h3>
          <div id="topPhotoContainer" style="width: 100%; aspect-ratio: 4/3; margin-bottom: 16px; overflow: hidden; border-radius: 12px;">
            <img id="topPhoto" src="" alt="最適合你的老師" loading="lazy"; style="width: 100%; height: 100%; object-fit: contain; background-color: #000;">
          </div>
          <h4 id="topName" style="margin:0 0 6px;font-size:24px;font-weight:800;"></h4>
          <div id="topTags" class="pills" style="justify-content:center; margin-bottom: 20px;"></div>
          <p id="topBio" class="muted" style="line-height:1.7;"></p>
          <div class="action-buttons">
            <button class="btn primary" id="submitBtn" style="justify-content:center;">送出問卷</button>
            <button class="btn" id="retryBtn" style="justify-content:center;">重新測一次</button>
          </div>     
        </div>

        <div class="card pad">
          <h4 style="margin:0 0 10px;font-size:20px;font-weight:700">次佳人選</h4>
          <p class="muted" style="font-size:12px;margin-top:12px">* 若最適合的時段滿班，以下老師也非常契合你的學習偏好。</p>

          <div id="runnerList" style="display:flex;justify-content: space-around; /* 或 space-between, center */align-items: flex-start;gap: 20px; /* 增加並列項目之間的間距 */"></div>
        </div>
      </div>
    </section>

    


  </div>

  <!-- 外部資料檔 -->
  <script src="assets/data/quiz_data.js"></script>

  <!-- 主程式 -->
  <script>
  const { questions, teachers } = window.quizData;

  // ========= 狀態 =========
  const $ = (s) => document.querySelector(s);
  const quizSection = $('#quizSection');
  const resultSection = $('#resultSection');
  const startQuizBtn = $('#startQuiz');
  const prevBtn = $('#prevBtn');
  const nextBtn = $('#nextBtn');
  const progressBar = $('#progressBar');
  const progressText = $('#progressText');
  const questionWrap = $('#questionWrap');

  const total = questions.length;
  let step = 0;       // 0=hero, 1=quiz, 2=result
  let current = 0;    // 目前題號 index
  // 答案陣列：單選存數字 index；複選存陣列 [index, index]；fields 題存成物件 {name: "...", ...}
  let answers = questions.map(q => q.fields ? {} : (q.multiple ? [] : null));

  // 🎯 樂器分流權重
  const INSTRUMENT_WEIGHT_EXACT = 3;
  const INSTRUMENT_WEIGHT_CROSS = 1;
  const INSTRUMENT_PREF_BONUS   = 2;
  const GUITAR_SET = new Set(["電吉他", "木吉他"]);

  // === 動態偵測題目索引 ===
  const INSTRUMENT_Q_INDEX = (() => {
    const byFlag = questions.findIndex(q => q.isInstrument === true);
    if (byFlag !== -1) return byFlag;
    const byTitle = questions.findIndex(q => typeof q.title === 'string' && /樂器|instrument/i.test(q.title));
    return byTitle !== -1 ? byTitle : 1; // 最後退路：假設第 2 題是樂器
  })();
  const INSTRUMENT_Q_ID_STR = String(questions[INSTRUMENT_Q_INDEX]?.id);

  const BASIC_Q_INDEX = questions.findIndex(q => String(q.id) === 'basic_Info');
  const NOTE_Q_INDEX  = questions.findIndex(q => String(q.id) === 'note_field');

  function getInstrumentAnswerIndex() {
    return answers[INSTRUMENT_Q_INDEX];
  }
  function getInstrumentLabel() {
    const idx = getInstrumentAnswerIndex();
    return (idx != null) ? questions[INSTRUMENT_Q_INDEX].options[idx] : null;
  }

  // ========= UI =========
  function showSection(which){
    quizSection.style.display = which === 1 ? 'block' : 'none';
    resultSection.style.display = which === 2 ? 'block' : 'none';
    const about = document.getElementById('about');
    if (about) about.style.display = (which === 0) ? 'block' : 'none';
    step = which;
  }

  function updateProgress(){
    const percent = Math.round(((current + 1) / total) * 100);
    progressBar.style.width = percent + '%';
    if (progressText) progressText.textContent = `${current + 1} / ${total}（${percent}%）`;
  }

  function renderQuestion(){
    updateProgress();
    const q = questions[current];
    questionWrap.innerHTML = '';

    const wrap = document.createElement('div');
    wrap.className = 'fade-enter';

    if (q.fields) {
      wrap.innerHTML = `
        <h2 style="margin:0 0 12px;font-size:24px;font-weight:800;">${q.title}</h2>
        <div style="display:grid;gap:16px;">
          ${q.fields.map(f => {
            if (f.type === "text") {
              return `
                <div>
                  <label class="muted" style="font-size:14px">${f.label}</label>
                  <input data-field="${f.id}" placeholder="${f.placeholder || ''}"
                    style="margin-top:6px;width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border)"
                    value="${answers[current]?.[f.id] ?? ''}">
                </div>`;
            } else if (f.type === "radio") {
              const opts = (f.options || []).map(opt => {
                const checked = answers[current]?.[f.id] === opt ? 'checked' : '';
                return `<label><input type="radio" name="${f.id}" value="${opt}" data-field="${f.id}" ${checked}> ${opt}</label>`;
              }).join('');
              return `
                <div>
                  <label class="muted" style="font-size:14px">${f.label}</label>
                  <div style="margin-top:6px;display:flex;gap:12px;flex-wrap:wrap;">${opts}</div>
                </div>`;
            } else if (f.type === "textarea") {
              return `
                <div>
                  <label class="muted" style="font-size:14px">${f.label}</label>
                  <textarea data-field="${f.id}" placeholder="${f.placeholder || ''}"
                    style="margin-top:6px;width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);height:120px">${answers[current]?.[f.id] ?? ''}</textarea>
                </div>`;
            }
            return '';
          }).join('')}
        </div>
      `;

      // 同步輸入到 answers[current]
      requestAnimationFrame(() => {
        const inputs = wrap.querySelectorAll("[data-field]");
        inputs.forEach(el => {
          if (el.type === "radio") {
            el.addEventListener("change", () => {
              answers[current] = answers[current] || {};
              answers[current][el.name] = el.value;
            });
          } else {
            el.addEventListener("input", () => {
              answers[current] = answers[current] || {};
              answers[current][el.getAttribute("data-field")] = el.value;
            });
          }
        });
      });

    } else if (q.options) {
      
        // === 特別處理：上課時段表格顯示 ===
        if (q.id === 7) {
          const days = ["星期一","星期二","星期三","星期四","星期五","星期六","星期日"];
          const times = ["10:00-13:00","13:00-15:00","15:00-18:00","18:00-21:30"];

          wrap.innerHTML = `
            <h2 style="margin:0 0 12px;font-size:24px;font-weight:800;">${q.title}</h2>
            <table style="border-collapse:collapse;width:100%;text-align:center;color:#fff;">
              <thead>
                <tr>
                  <th style="border:1px solid #666;padding:8px;">時段 \\ 星期</th>
                  ${days.map(d=>`<th style="border:1px solid #666;padding:8px;">${d}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${times.map(t=>{
                  return `<tr>
                    <td style="border:1px solid #666;padding:8px;">${t}</td>
                    ${days.map((d,di)=>{
                      const label = `${d}${t}`;
                      const idx = q.options.indexOf(label);
                      const disabled = (t==="10:00-13:00" && di<5); // 星期一~五早上禁用
                      const selected = (answers[current]||[]).includes(idx);
                      return `<td style="border:1px solid #666;padding:6px;">
                        <input type="checkbox" data-index="${idx}" ${selected?'checked':''} ${disabled?'disabled':''}>
                      </td>`;
                    }).join('')}
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          `;

          // 綁定多選事件
          const inputs = wrap.querySelectorAll('input[type=checkbox]');
          inputs.forEach(cb=>{
            cb.addEventListener('change',()=>{
              const i = Number(cb.getAttribute('data-index'));
              const arr = Array.isArray(answers[current]) ? [...answers[current]] : [];
              const pos = arr.indexOf(i);
              if (cb.checked && pos === -1) arr.push(i);
              else if (!cb.checked && pos !== -1) arr.splice(pos,1);
              answers[current] = arr;
            });
          });

        } else {
          // === 其他題目維持原本的樣式 ===

      wrap.innerHTML = `
        <h2 style="margin:0 0 12px;font-size:24px;font-weight:800;">${q.title}</h2>
        <div class="options">
          ${q.options.map((label, i) => `
            <button class="option ${q.multiple ? (answers[current]||[]).includes(i) ? 'selected':'' : (answers[current]===i?'selected':'')}"
                    data-index="${i}">
              <span class="num">${i+1}</span>
              <span>${label}</span>
            </button>
          `).join('')}
        </div>
      `;
      const optionButtons = wrap.querySelectorAll('.option');
      optionButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.getAttribute('data-index'));
          if (q.multiple) {
            const arr = Array.isArray(answers[current]) ? [...answers[current]] : [];
            const pos = arr.indexOf(i);
            if (pos === -1) arr.push(i); else arr.splice(pos, 1);
            answers[current] = arr;
            btn.classList.toggle('selected');
          } else {
            answers[current] = i;
            optionButtons.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
          }
        });
      });
    }
  }

    questionWrap.appendChild(wrap);
    requestAnimationFrame(()=>{ wrap.className = 'fade-enter active'; });
  }

  // ========= 配對演算法 =========
  function computeScores(){
    const ansInstrumentIdx = getInstrumentAnswerIndex();
    const instrumentLabel = getInstrumentLabel();

    // 候選老師
    const candidates = teachers.filter(t => {
      if (!instrumentLabel) return true;
      if (GUITAR_SET.has(instrumentLabel)) {
        return GUITAR_SET.has(t.instrument);
      } else {
        const canTeach = Array.isArray(t.canTeach)
          ? t.canTeach.includes(instrumentLabel)
          : (t.instrument === instrumentLabel);
        return canTeach;
      }
    });

    const scoreList = candidates.map(t => {
      let score = 0;

      // 樂器加權
      if (instrumentLabel) {
        if (GUITAR_SET.has(instrumentLabel)) {
          score += (t.instrument === instrumentLabel)
            ? INSTRUMENT_WEIGHT_EXACT
            : INSTRUMENT_WEIGHT_CROSS;
        } else {
          score += (t.instrument === instrumentLabel)
            ? INSTRUMENT_WEIGHT_EXACT
            : INSTRUMENT_WEIGHT_CROSS;
        }
        // 偏好加成（注意：老師的 preferences key 是題目 id，1-based 選項 +1）
        const prefInstrument = t.preferences?.[questions[INSTRUMENT_Q_INDEX].id];
        if (prefInstrument && prefInstrument.includes(ansInstrumentIdx + 1)) {
          score += INSTRUMENT_PREF_BONUS;
        }
      }

      // 其他題（跳過樂器題）
      questions.forEach((q, qi) => {
        if (String(q.id) === INSTRUMENT_Q_ID_STR) return;

        const accept = t.preferences[q.id];
        if (!accept) return;

        const ans = answers[qi];
        if (q.fields) return; // fields 題（基本資料 / 備註）不進配對分數

        if (q.multiple) {
          (ans || []).forEach(idx => { if (accept.includes(idx + 1)) score += 1; });
        } else {
          if (ans != null && accept.includes(ans + 1)) score += 1;
        }
      });

      return { id: t.id, score };
    });

    scoreList.sort((a,b) => b.score - a.score);
    return scoreList;
  }

  function renderResult(){
    const ranking = computeScores();
    const top = teachers.find(t => t.id === ranking[0]?.id);
    const instrumentLabel = getInstrumentLabel();

    const topPhoto = $('#topPhoto');
    const topName = $('#topName');
    const topBio  = $('#topBio');
    const topTags = $('#topTags');

    if (!top) {
      if (topName) topName.textContent = '暫無對應老師';
      if (topBio)  topBio.textContent  = instrumentLabel
        ? `目前尚無「${instrumentLabel}」對應的老師，歡迎先留言，我們會協助安排或推薦。`
        : '目前暫無推薦，請調整作答條件再試一次。';
    }
    const runners = ranking.slice(1,3).map(r => teachers.find(t => t.id === r.id));

    topPhoto.src = top?.photo || 'https://placehold.co/600x400?text=No+Recommended+Teachers';
    topPhoto.alt = top?.name || '最佳老師';
    topName.textContent = top?.name || '暫無推薦';
    topBio.textContent  = top
      ? `授課樂器：${top.instrument}｜（可聯絡我們安排體驗課）`
      : '請調整你的作答條件再試一次。';
    topTags.innerHTML = '';
    if (top){
      ["#"+top.instrument, top.gender ? "性別："+top.gender : null]
        .filter(Boolean)
        .forEach(tag=>{
          const el = document.createElement('span');
          el.className = 'pill';
          el.textContent = tag;
          topTags.appendChild(el);
        });
    }

    const runnerList = $('#runnerList');
    runnerList.innerHTML = '';
    runners.forEach(r => {
      if (!r) return;
      const row = document.createElement('div');
      row.className = 'runner';
      row.innerHTML = `
        <img src="${r.photo || 'https://placehold.co/96x96?text=T'}" alt="${r.name}" loading="lazy">
        <div>
          <div style="font-weight:600">${r.name}</div>
          <div class="muted" style="font-size:13px">授課樂器：${r.instrument}</div>
        </div>`;
      runnerList.appendChild(row);
    });
  }

  // ========= 導航 =========
  function next(){
    const q = questions[current];
    // 若是 fields 題，進一步保險：把當前畫面值寫回 answers[current]
    if (q.fields) {
      answers[current] = answers[current] || {};
      q.fields.forEach(f => {
        if (f.type === "radio") {
          const checked = document.querySelector(`[name="${f.id}"]:checked`);
          if (checked) answers[current][f.id] = checked.value;
        } else {
          const el = document.querySelector(`[data-field="${f.id}"]`);
          if (el) answers[current][f.id] = (el.value || '').trim();
        }
      });
    }

    if (current < total - 1){
      current++;
      renderQuestion();
    } else {
      renderResult();
      showSection(2);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }
  function prev(){ if (current > 0){ current--; renderQuestion(); } }
  function resetAll(){
    current = 0;
    answers = questions.map(q => q.fields ? {} : (q.multiple ? [] : null));
    showSection(1);
    renderQuestion();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ========= 綁定 =========
  startQuizBtn.addEventListener('click', e => { e.preventDefault(); showSection(1); renderQuestion(); });
  nextBtn.addEventListener('click', next);
  prevBtn.addEventListener('click', prev);
  document.addEventListener('keydown', e => { if (step===1){ if (e.key==='ArrowRight') next(); if (e.key==='ArrowLeft') prev(); }});
  const yearEl = $('#year'); if (yearEl) yearEl.textContent = new Date().getFullYear();

  document.addEventListener('click', (e)=>{ if (e.target && e.target.id === 'retryBtn') resetAll(); });

  // ========= 送出到 Apps Script =========
  const GS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzGigK_7H_XClb_RV3fv5LgzuTRzNP9RVISCLwPiLOHQBhEKD2KGEIDcLpZ3blDidd8OQ/exec';

  // 取得單題答案：複選→陣列(標籤文字)；單選→文字
  function getAnswer(q, qi) {
    if (q.fields) return null; // fields 題不走這裡
    if (q.multiple) return (answers[qi] || []).map(i => q.options[i]);
    const i = answers[qi];
    return (i != null ? q.options[i] : '');
  }

  // 組 payload（**改：從 answers 取值**）
  function buildPayload() {
    const ranking = computeScores();
    const top = teachers.find(t => t.id === ranking[0]?.id);
    const topText = top ? `${top.name}（${top.instrument}）` : '無';
    const top3 = (ranking || []).slice(0,3)
      .map((r,i)=>`${i+1}.${teachers.find(t=>t.id===r.id)?.name || r.id}(${r.score})`)
      .join(' / ');
    const match = `${topText}｜Top3：${top3}`;

    const payload = { match };

    // 基本資料（來自 answers，而非 DOM）
    const basic = BASIC_Q_INDEX >= 0 ? (answers[BASIC_Q_INDEX] || {}) : {};
    payload.name    = basic.name    || '';
    payload.gender  = basic.gender  || '';
    payload.job     = basic.job     || '';
    payload.contact = basic.contact || '';

    // 備註（來自 answers）
    const noteObj = NOTE_Q_INDEX >= 0 ? (answers[NOTE_Q_INDEX] || {}) : {};
    payload.note = noteObj.note || '';

    // 問卷選項（把每題的文字都帶上）
    questions.forEach((q, idx) => {
      if (q.fields) return;
      payload[`q${q.id}`] = getAnswer(q, idx);
    });

    // 額外也把樂器題的文字帶一份（方便表單快速檢索）
    payload.instrument = getInstrumentLabel() || '';

    return payload;
  }

  // 結果頁「送出問卷」
  const submitQuestionBtn = document.getElementById('submitBtn');
  const statusMessageContainer = document.getElementById('contactStatus'); // 可能不存在，容錯即可

  if (submitQuestionBtn) {
    submitQuestionBtn.addEventListener('click', async () => {
      submitQuestionBtn.disabled = true;
      submitQuestionBtn.textContent = '傳送中...';
      if (statusMessageContainer) statusMessageContainer.textContent = '正在傳送資料...';

      try {
        const payload = buildPayload();
        console.log('payload =', payload);

        await fetch(GS_ENDPOINT, {
          method: 'POST',
          mode: 'no-cors',                       // 避開預檢
          headers: { 'Content-Type': 'text/plain' }, // simple request
          body: JSON.stringify(payload),
          keepalive: true
        });

        // opaque response 無法讀，只要沒 throw 就當成功
        if (statusMessageContainer) statusMessageContainer.textContent = '資料已成功送出！';
        alert('問卷已成功送出，我們會盡快與你聯絡！');

      } catch (err) {
        console.error('送出失敗:', err);
        if (statusMessageContainer) statusMessageContainer.textContent = '送出失敗，請稍後再試。';
        alert('送出失敗，請稍後再試。');
      } finally {
        submitQuestionBtn.disabled = false;
        submitQuestionBtn.textContent = '送出問卷';
      }
    });
  }
</script>


      <!-- Contact放頁尾 -->
<footer id="contact" class="card" style="margin:28px auto; background-color: #1a1a1a; /* 自定義一個深色背景，與主頁面背景區隔 */">
  <div style="max-width: 900px; width: 100%; padding: 30px 20px; text-align: center; margin: 0 auto;">
    <p class="muted" style="margin-top:0; color: #aaa;">台南市東區東寧路西段22號｜(06)236-7528</p>

    <div style="display:flex; gap:20px; flex-wrap:wrap; margin-top:20px; justify-content:center;">
      <a href="https://www.instagram.com/room2music/" target="_blank" style="width:56px; height:56px; display:flex; justify-content:center; align-items:center; background-color: #333; border-radius:12px; transition:transform 0.2s; cursor:pointer;">
        <img src="photo/instagram.png" alt="Instagram" style="width:48px; height:48px; object-fit:contain;">
      </a>
      <a href="https://www.facebook.com/ROOM2MUSIC/?locale=zh_TW" target="_blank" style="width:56px; height:56px; display:flex; justify-content:center; align-items:center; background-color: #333; border-radius:12px; transition:transform 0.2s; cursor:pointer;">
        <img src="photo/facebook.png" alt="Facebook" style="width:48px; height:48px; object-fit:contain;">
      </a>
      <a href="https://maps.app.goo.gl/xkhWrudjteqcfzjs9" target="_blank" style="width:56px; height:56px; display:flex; justify-content:center; align-items:center; background-color: #333; border-radius:12px; transition:transform 0.2s; cursor:pointer;">
        <img src="photo/googlemap.png" alt="Google Map" style="width:48px; height:48px; object-fit:contain;">
      </a>
    </div>
  </div>
</footer>
</body>
</html>
